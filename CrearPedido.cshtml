@model IEnumerable<RANCHO_AZUL.Models.Menu>

@{
    ViewData["Title"] = "Crear Pedido";
}

<div class="container mt-4">

    <h2 class="text-primary mb-4">
        <i class="fas fa-clipboard-list me-2"></i>
        Crear Nuevo Pedido
    </h2>

    <!-- Selección de Mesa -->
    <div class="card shadow mb-4">
        <div class="card-body">
            <h5 class="card-title text-secondary">
                <i class="fas fa-chair me-2"></i>
                1. Seleccionar Mesa
            </h5>

            <select id="mesaSeleccionada" class="form-select form-select-lg">
                <option value="">-- Seleccione una mesa --</option>
                @for (int i = 1; i <= 7; i++)
                {
                    <option value="@i">Mesa @i</option>
                }
            </select>
        </div>
    </div>

    <!-- Datos del Cliente -->
    <div class="card shadow mb-4">
        <div class="card-body">
            <h5 class="card-title text-secondary">
                <i class="fas fa-user me-2"></i>
                2. Datos del Cliente
            </h5>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Nombre del Cliente *</label>
                    <input type="text"
                           id="nombreCliente"
                           class="form-control form-control-lg"
                           placeholder="Ej: Juan"
                           pattern="[A-Za-zÁÉÍÓÚáéíóúÑñ ]{2,50}"
                           title="Solo se permiten letras y espacios"
                           oninput="this.value = this.value.replace(/[^A-Za-zÁÉÍÓÚáéíóúÑñ ]/g,'')"
                           required>
                    <small class="text-muted">Solo letras</small>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Apellido del Cliente *</label>
                    <input type="text"
                           id="apellidoCliente"
                           class="form-control form-control-lg"
                           placeholder="Ej: Pérez"
                           pattern="[A-Za-zÁÉÍÓÚáéíóúÑñ ]{2,50}"
                           title="Solo se permiten letras y espacios"
                           oninput="this.value = this.value.replace(/[^A-Za-zÁÉÍÓÚáéíóúÑñ ]/g,'')"
                           required>
                    <small class="text-muted">Solo letras</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Menú disponible -->
    <div class="card shadow mb-4">
        <div class="card-body">
            <h5 class="card-title text-secondary">
                <i class="fas fa-utensils me-2"></i>
                3. Seleccionar Platos
            </h5>

            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>Plato</th>
                            <th>Categoría</th>
                            <th>Precio</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var m in Model)
                        {
                            <tr>
                                <td>
                                    <strong>@m.Nombre</strong>
                                    <br>
                                    <small class="text-muted">@m.Descripcion</small>
                                </td>
                                <td>
                                    <span class="badge bg-info">@m.CategoriaMenus?.NombreDeCategoria</span>
                                </td>
                                <td><strong class="text-success">S/. @m.Precio.ToString("0.00")</strong></td>
                                <td>
                                    <button class="btn btn-success btn-sm agregar-plato"
                                            data-id="@m.IdMenu"
                                            data-nombre="@m.Nombre"
                                            data-precio="@m.Precio">
                                        <i class="fas fa-plus me-1"></i>Agregar
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Resumen del pedido -->
    <div class="card shadow mb-4">
        <div class="card-body">
            <h5 class="card-title text-secondary">
                <i class="fas fa-shopping-cart me-2"></i>
                4. Resumen del Pedido
            </h5>

            <div class="table-responsive">
                <table class="table table-bordered" id="tablaPedido">
                    <thead class="table-light">
                        <tr>
                            <th>Plato</th>
                            <th>Cantidad</th>
                            <th>Precio Unit.</th>
                            <th>Subtotal</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                    <tfoot>
                        <tr class="table-primary">
                            <td colspan="3" class="text-end"><strong>TOTAL:</strong></td>
                            <td colspan="2"><strong class="fs-4 text-success">S/. <span id="totalPedido">0.00</span></strong></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <!-- Botones de acción -->
    <div class="d-flex justify-content-between mb-5">
        <a href="@Url.Action("PanelMesero", "Mesero")" class="btn btn-outline-secondary btn-lg">
            <i class="fas fa-arrow-left me-2"></i>Cancelar
        </a>
        <button id="btnEnviarPedido" class="btn btn-primary btn-lg">
            <i class="fas fa-paper-plane me-2"></i>Enviar Pedido
        </button>
    </div>

</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>

        $(document).ready(function () {

            let listaPedido = [];

            // Agregar plato al pedido
            $(".agregar-plato").on("click", function () {

                let id = $(this).data("id");
                let nombre = $(this).data("nombre");
                let precio = parseFloat($(this).data("precio"));

                let existente = listaPedido.find(p => p.id === id);

                if (existente) {
                    existente.cantidad++;
                } else {
                    listaPedido.push({
                        id: id,
                        nombre: nombre,
                        precio: precio,
                        cantidad: 1
                    });
                }

                actualizarTabla();
            });


            // Actualizar tabla del pedido
            function actualizarTabla() {

                let cuerpo = $("#tablaPedido tbody");
                cuerpo.empty();

                let total = 0;

                listaPedido.forEach(item => {

                    let subtotal = item.precio * item.cantidad;
                    total += subtotal;

                    cuerpo.append(`
                        <tr>
                            <td><strong>${item.nombre}</strong></td>
                            <td>
                                <span class="badge bg-info fs-6">${item.cantidad}</span>
                            </td>
                            <td>S/. ${item.precio.toFixed(2)}</td>
                            <td><strong class="text-success">S/. ${subtotal.toFixed(2)}</strong></td>
                            <td>
                                <button class="btn btn-danger btn-sm eliminar" data-id="${item.id}">
                                    <i class="fas fa-trash me-1"></i>Quitar
                                </button>
                            </td>
                        </tr>
                    `);
                });

                $("#totalPedido").text(total.toFixed(2));
            }

            // Eliminar plato
            $(document).on("click", ".eliminar", function () {
                let id = $(this).data("id");
                listaPedido = listaPedido.filter(p => p.id !== id);
                actualizarTabla();
            });


            // Enviar pedido al backend
            $("#btnEnviarPedido").click(function () {

                let mesa = $("#mesaSeleccionada").val();
                let nombreCliente = $("#nombreCliente").val().trim();
                let apellidoCliente = $("#apellidoCliente").val().trim();

                // Validaciones
                if (!mesa) {
                    alert("⚠️ Debe seleccionar una mesa.");
                    $("#mesaSeleccionada").focus();
                    return;
                }

                if (!nombreCliente) {
                    alert("⚠️ Debe ingresar el nombre del cliente.");
                    $("#nombreCliente").focus();
                    return;
                }

                if (!apellidoCliente) {
                    alert("⚠️ Debe ingresar el apellido del cliente.");
                    $("#apellidoCliente").focus();
                    return;
                }

                // Validar que solo contengan letras
                const soloLetras = /^[A-Za-zÁÉÍÓÚáéíóúÑñ ]+$/;
                if (!soloLetras.test(nombreCliente)) {
                    alert("⚠️ El nombre solo debe contener letras.");
                    $("#nombreCliente").focus();
                    return;
                }

                if (!soloLetras.test(apellidoCliente)) {
                    alert("⚠️ El apellido solo debe contener letras.");
                    $("#apellidoCliente").focus();
                    return;
                }

                if (listaPedido.length === 0) {
                    alert("⚠️ Debe agregar al menos un plato al pedido.");
                    return;
                }

                // Confirmar envío
                if (!confirm(`¿Enviar pedido de la Mesa ${mesa} para ${nombreCliente} ${apellidoCliente}?`)) {
                    return;
                }

                // Deshabilitar botón mientras se procesa
                $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Enviando...');

                $.ajax({
                    url: "/Pedidos/GuardarPedidoMesero",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({
                        mesaId: parseInt(mesa),
                        nombreCliente: nombreCliente,
                        apellidoCliente: apellidoCliente,
                        items: listaPedido.map(item => ({
                            menuId: item.id,
                            cantidad: item.cantidad
                        }))
                    }),
                    success: function (response) {
                        if (response.success) {
                            alert("✅ " + response.message);
                            window.location.href = "/Pedidos/Activos";
                        } else {
                            alert("❌ Error: " + response.message);
                            $("#btnEnviarPedido").prop('disabled', false).html('<i class="fas fa-paper-plane me-2"></i>Enviar Pedido');
                        }
                    },
                    error: function () {
                        alert("❌ Error al guardar el pedido. Intente nuevamente.");
                        $("#btnEnviarPedido").prop('disabled', false).html('<i class="fas fa-paper-plane me-2"></i>Enviar Pedido');
                    }
                });

            });

        });

    </script>
}